# DiffStock 最优策略配置与组合仓位调整逻辑说明

## 目录

1. [系统架构概览](#1-系统架构概览)
2. [模型原理：TimeGrad 扩散模型](#2-模型原理timegrad-扩散模型)
3. [最优策略配置指南](#3-最优策略配置指南)
4. [组合仓位调整逻辑详解](#4-组合仓位调整逻辑详解)
5. [关键参数说明与调优建议](#5-关键参数说明与调优建议)
6. [实操流程](#6-实操流程)
7. [风险提示](#7-风险提示)

---

## 1. 系统架构概览

DiffStock 的完整工作流由三个阶段组成：

```
训练阶段 (Train)
  │  18只多元资产 × 5年历史数据
  │  LSTM Encoder + WaveNet Denoiser
  │  200 Epochs, Early Stopping
  ▼
预测阶段 (Forecast)
  │  每只资产 → 500条蒙特卡洛扩散路径
  │  输出：期望收益、波动率、Sharpe、P10/P50/P90 价格
  ▼
优化阶段 (Portfolio Optimization)
  │  10万次随机采样 + 5万次局部扰动精炼
  │  目标函数：Sharpe - 0.5 × CVaR
  │  波动率靶向叠加层 → 最终权重
  ▼
  输出：各资产权重、杠杆倍数、预期收益/风险指标
```

---

## 2. 模型原理：TimeGrad 扩散模型

### 2.1 前向扩散过程

模型在训练阶段学习如何从噪声中恢复出真实的价格变化序列：

$$x_t = \sqrt{\bar{\alpha}_t} \cdot x_0 + \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon, \quad \epsilon \sim \mathcal{N}(0, I)$$

其中：
- $x_0$ 是真实的未来收益率序列
- $\bar{\alpha}_t$ 是噪声调度的累积乘积（线性调度，$\beta$ 从 $10^{-4}$ 到 $0.02$）
- 扩散步数 $T = 100$

### 2.2 反向去噪（推理/采样）

在推理时，模型从纯高斯噪声出发，经过 100 步逐步去噪，生成价格预测路径：

$$x_{t-1} = \frac{1}{\sqrt{\alpha_t}} \left( x_t - \frac{\beta_t}{\sqrt{1 - \bar{\alpha}_t}} \epsilon_\theta(x_t, t, c) \right) + \sigma_t z$$

其中 $\epsilon_\theta$ 是训练好的噪声预测网络，$c$ 是 LSTM 编码器产出的历史序列上下文向量。

### 2.3 网络结构

| 组件 | 结构 | 参数 |
|------|------|------|
| **历史编码器** | LSTM | input_dim=2 (close_return, overnight_return), hidden_dim=128 |
| **噪声预测器** | WaveNet 风格残差网络 | 4层膨胀因果卷积, 128通道, 门控激活 |
| **资产嵌入** | Embedding | 18 个训练资产各有独立嵌入向量 |
| **扩散嵌入** | 2层MLP + SiLU | 将时间步 $t$ 编码为向量 |

---

## 3. 最优策略配置指南

### 3.1 训练阶段配置

| 参数 | 默认值 | 推荐范围 | 说明 |
|------|--------|----------|------|
| `Epochs` | 200 | 150–500 | 更多 epoch 可提升精度，但过拟合风险增加，依靠 Early Stopping 保护 |
| `Batch Size` | 64 | 32–128 | 较小 batch 增加随机性（正则化效果），较大 batch 训练更稳定 |
| `Learning Rate` | 0.001 | 5e-4 ~ 2e-3 | 初始学习率，每 50 epoch 自动衰减 50% |
| `Patience` | 20 | 10–30 | 验证集无改善 N 轮后自动停止，防止过拟合 |

**最优训练建议：**

```
Epochs = 300        ← 给模型充分学习时间
Batch Size = 64     ← 默认值平衡良好
Learning Rate = 0.001  ← 默认值即可，衰减机制会自动调节
Patience = 20       ← 够用，确保收敛
```

训练数据覆盖 **18 只多元化资产**（SPY, DIA, QQQ, XLK, XLI, XLF, XLC, XLY, XLRE, XLV, XLU, XLP, XLE, XLB, ARKK, NVDA, QQQI, RDVI），涵盖大盘指数、行业 ETF 和个股，确保模型学到通用的市场动力学模式。

### 3.2 组合优化配置

| 参数 | 当前值 | 作用 |
|------|--------|------|
| `PORTFOLIO_MC_PATHS` | 500 | 每只资产的蒙特卡洛采样路径数；越多统计越稳定，但推理时间线性增长 |
| `PORTFOLIO_HORIZON` | 10 天 | 预测并优化的前瞻窗口（2 个交易周） |
| `RISK_FREE_RATE` | 5% | 无风险利率，用于 Sharpe 计算 |
| `MAX_SINGLE_WEIGHT` | 40% | 单一资产最大权重，防止集中度风险 |
| `MIN_SINGLE_WEIGHT` | 2% | 最小有意义权重，避免"灰尘仓位" |
| `TARGET_ANNUAL_VOL` | 16% | 目标年化波动率（全天候基金水平） |
| `OPTIMIZER_SAMPLES` | 100,000 | 第一阶段随机搜索数量 |

### 3.3 获得最优策略的操作建议

1. **先训练模型**：在 Train 页面使用推荐参数训练，等待 `model_weights.safetensors` 保存成功
2. **选择资产池**：在 Portfolio 页面输入 6–10 只标的，建议：
   - 包含 **核心宽基指数**（SPY, QQQ）降低系统风险
   - 包含 **高 Alpha 个股**（NVDA, META 等）捕捉超额收益
   - 适度加入 **低相关资产**（XLU, XLRE）提升分散化
3. **推荐资产组合**：`NVDA,MSFT,AAPL,GOOGL,AMZN,META,QQQ,SPY`
4. **执行频率**：每 1–2 周重新运行优化器并调仓

---

## 4. 组合仓位调整逻辑详解

### 4.1 完整流程概览

仓位调整由 `optimize_portfolio()` 函数驱动，共分为 **五个步骤**：

```
Step 1: 扩散模型蒙特卡洛采样 → 每资产 500 条 10 天的收益率路径
Step 2: 协方差矩阵估计 → 从 MC 路径计算资产间联合风险结构
Step 3: 第一阶段优化 → 10 万次 Dirichlet 随机采样寻找最高 Sharpe
Step 4: 第二阶段精炼 → 5 万次局部扰动寻找 Sharpe↑ 且 CVaR↓ 的最优解
Step 5: 波动率靶向叠加 → 缩放杠杆使组合波动率逼近 16%
```

### 4.2 Step 1: 蒙特卡洛扩散采样

对于每只资产 $i$：

1. 获取最近 50 天的历史数据
2. 计算 close return 和 overnight return 序列
3. Z-score 标准化：$\tilde{r} = \frac{r - \mu}{\sigma}$
4. LSTM 编码器将标准化序列编码为上下文向量 $c$
5. 执行 500 次反向扩散采样：
   - 从 $x_T \sim \mathcal{N}(0,1)$ 出发
   - 经过 100 步去噪得到预测的标准化收益率
   - 反标准化：$\hat{r} = \tilde{r} \cdot \sigma + \mu$
   - 累积 10 天收益率得到一条路径的总 log-return

最终得到每只资产的 **500 个累积 log-return 样本**，它们构成了资产收益的概率分布。

### 4.3 Step 2: 协方差矩阵估计

从 $N$ 只资产各 $K=500$ 条 MC 路径中估计收益的联合分布：

$$\hat{\mu}_i = \frac{1}{K}\sum_{k=1}^K r_i^{(k)}$$

$$\hat{\Sigma}_{ij} = \frac{1}{K-1}\sum_{k=1}^K (r_i^{(k)} - \hat{\mu}_i)(r_j^{(k)} - \hat{\mu}_j)$$

**关键：** 由于所有 MC 路径使用共享的噪声生成器，路径编号 $k$ 之间隐式保持时序对齐，使得协方差矩阵能捕捉资产间的条件相关结构。

### 4.4 Step 3: 第一阶段优化 — 最大化 Sharpe

通过 **Dirichlet 采样**生成 100,000 个满足约束的随机权重向量：

```
对于每个候选组合 w = (w_1, ..., w_N):
  约束检查：
    ✓ Σ w_i = 1 （权重归一化）
    ✓ ∀i: w_i ≤ 0.40 （单资产上限）
    ✓ ∀i: w_i = 0 或 w_i ≥ 0.02 （最小仓位）

  计算：
    组合期望收益: μ_p = Σ w_i · μ_i × (252/10)  [年化]
    组合方差:     σ²_p = w^T · Σ · w × (252/10)  [年化]
    Sharpe 比率:  S = (μ_p - r_f) / σ_p

  保留 Sharpe 最高者
```

**Dirichlet 采样**的优势在于自动生成归一化的正权重向量，保证组合合法性。

### 4.5 Step 4: 第二阶段精炼 — Sharpe + CVaR 联合目标

以第一阶段的最优权重为起点，进行 50,000 次**局部扰动搜索**：

```
目标函数: Score = Sharpe - 0.5 × CVaR₉₅
```

每次迭代：
1. 从当前最优权重出发，每个分量加减 [-5%, +5%] 的随机扰动
2. 重新归一化使权重和为 1
3. 检查约束（单仓上限、最小仓位）
4. 计算新的 Sharpe 和 CVaR
5. 如果 Score 更优，更新最优权重

**CVaR (Conditional Value at Risk)** 的计算逻辑：

$$\text{CVaR}_{95\%} = -\frac{1}{\lfloor 0.05K \rfloor} \sum_{k=1}^{\lfloor 0.05K \rfloor} r_{(k)}^{\text{portfolio}}$$

即取组合 500 条 MC 路径中**最差的 5%（25 条路径）的平均损失**。

目标函数中 `Sharpe - 0.5 × CVaR` 的含义：
- **Sharpe** 项推动组合追求高风险调整后收益
- **-0.5 × CVaR** 项惩罚极端亏损风险
- **0.5 的系数**在进攻与防御之间取得平衡

### 4.6 Step 5: 波动率靶向叠加 (Vol-Targeting Overlay)

优化出的"原始权重"可能波动率过高或过低。通过杠杆缩放使组合达到目标年化波动率：

$$\text{Leverage} = \frac{\sigma_{\text{target}}}{\sigma_{\text{portfolio}}} = \frac{16\%}{\sigma_p}$$

杠杆被限制在 **0.5x – 2.0x** 范围内：

| 场景 | 组合原始波动率 | 杠杆 | 含义 |
|------|---------------|------|------|
| 高波市场 | σ_p = 32% | 0.5x | 减仓 50%，剩余为现金 |
| 适中波动 | σ_p = 16% | 1.0x | 不调整 |
| 低波市场 | σ_p = 8% | 2.0x | 满仓杠杆，等效 200% 仓位 |

最终权重 = 原始权重 × 杠杆倍数。

**如果杠杆 < 1**，意味着持有现金（减仓保护）。
**如果杠杆 > 1**，意味着建议使用杠杆或保证金（增加暴露）。

### 4.7 输出结果

最终输出包含：

| 指标 | 含义 |
|------|------|
| **权重 (Weight)** | 每只资产应占组合的比例（已乘以杠杆） |
| **预期年化收益** | 基于扩散模型的组合期望回报 |
| **预期年化波动率** | 组合风险水平（靶向 ~16%） |
| **Sharpe 比率** | 每单位风险的超额收益，>1.0 为良好 |
| **CVaR (95%)** | 5% 最差情况下的预期损失 |
| **杠杆倍数** | Vol-targeting 缩放因子 |
| **$100K 分配** | 按 10 万美元计算的每只资产美元金额和股数 |

---

## 5. 关键参数说明与调优建议

### 5.1 追求更高收益

| 调整项 | 方法 | 风险 |
|--------|------|------|
| 增加 `MAX_SINGLE_WEIGHT` | 改为 0.50–0.60 | 集中度风险增加 |
| 增加 `TARGET_ANNUAL_VOL` | 改为 0.20–0.25 | 允许更大波动换取更高预期收益 |
| 减小 CVaR 惩罚系数 | 在 `refine_weights` 中把 0.5 改为 0.2 | 降低对尾部风险的保护 |
| 选择高 Alpha 资产 | 集中在个股而非 ETF | 个股波动更大，模型可靠性下降 |

### 5.2 追求更稳健的策略

| 调整项 | 方法 | 效果 |
|--------|------|------|
| 降低 `TARGET_ANNUAL_VOL` | 改为 0.10–0.12 | 更保守的仓位，类似债券组合波动 |
| 增加 CVaR 惩罚 | 系数改为 1.0–2.0 | 更强的尾部风险规避 |
| 增加 `PORTFOLIO_MC_PATHS` | 改为 1000–2000 | 统计更稳定但耗时更长 |
| 使用分散化资产池 | 加入 XLU, XLP, XLRE | 降低组合相关性 |

### 5.3 调仓频率与实操建议

| 策略风格 | 建议调仓频率 | 说明 |
|----------|-------------|------|
| 积极型 | 每周一次 | 与 10 天预测窗口匹配 |
| 均衡型 | 每两周一次 | 减少交易成本 |
| 保守型 | 每月一次 | 仅在权重偏离 >5% 时调仓 |

---

## 6. 实操流程

### 6.1 首次使用

```bash
# 1. 在 GUI 的 Train 页面训练模型
#    推荐参数: Epochs=300, Batch=64, LR=0.001, Patience=20
#    等待训练完成，model_weights.safetensors 自动保存

# 2. 切换到 Portfolio 页面
#    输入: NVDA,MSFT,AAPL,GOOGL,AMZN,META,QQQ,SPY
#    点击 Optimize

# 或使用命令行:
cargo run --release -- --portfolio NVDA,MSFT,AAPL,GOOGL,AMZN,META,QQQ,SPY
```

### 6.2 定期调仓

每 1–2 周重新运行 Portfolio Optimize：

1. 模型会拉取最新的市场数据
2. 重新运行 500 条蒙特卡洛路径
3. 基于当前市场状态计算新的最优权重
4. 对比当前持仓与建议权重，执行调仓

### 6.3 调仓判断规则（建议）

```
如果 |当前权重 - 建议权重| > 5%：执行调仓
如果 |当前权重 - 建议权重| ≤ 5%：不调仓（节省交易成本）
如果 杠杆 < 0.7：减仓至建议水平，剩余转为现金
如果 杠杆 > 1.5：谨慎对待，仅在高确信度时使用杠杆
```

---

## 7. 风险提示

1. **模型风险**：扩散模型基于历史数据训练，无法预测黑天鹅事件
2. **样本外效果**：回测表现不代表实盘表现
3. **过拟合风险**：模型可能过拟合近期市场模式
4. **流动性风险**：高集中度仓位在市场震荡时可能难以平仓
5. **杠杆风险**：杠杆 > 1x 会放大损失
6. **数据依赖**：模型质量取决于历史数据的准确性和完整性

**本系统仅供教育和研究目的，不构成投资建议。任何投资决策请自行承担风险。**

---

*文档版本: 2026-02-14 | DiffStock v0.1.0*
